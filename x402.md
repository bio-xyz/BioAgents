# x402 Payment Protocol Integration

BioAgents AgentKit supports USDC micropayments for API access using the x402 payment protocol with Coinbase's embedded wallet infrastructure. The system implements a **three-tier access control model** for flexible API monetization.

## Three-Tier Access Control

The `/api/chat` endpoint supports three distinct access patterns:

| Tier | Authentication | Payment Required | Use Case |
|------|----------------|------------------|----------|
| **1. Next.js Frontend (Privy)** | Privy JWT | ❌ FREE (bypasses x402) | Paying customers via subscription model |
| **2. Internal Dev UI (CDP)** | CDP Wallet Signature | ✅ Requires x402 | Internal development and testing |
| **3. External Agents (x402)** | None | ✅ Requires x402 | AI agents and external API consumers |

## How Bypass Works

The system uses a two-stage middleware pipeline:

1. **smartAuthMiddleware** ([src/middleware/smartAuth.ts](src/middleware/smartAuth.ts)) - Runs first, verifies credentials and sets bypass flag
2. **x402Middleware** ([src/middleware/x402.ts](src/middleware/x402.ts)) - Runs second, checks bypass flag and enforces payment

### Flow Diagram

```
Request → smartAuthMiddleware → x402Middleware → Route Handler
           (decides bypass)      (checks bypass)
```

### Bypass Decision Logic

```typescript
// In smartAuthMiddleware (src/middleware/smartAuth.ts)
if (Privy JWT verified) {
  request.bypassX402 = true;  // ✅ Bypass payment
}

// In x402Middleware (src/middleware/x402.ts)
if (request.bypassX402) {
  return; // Skip payment check entirely
}
// Otherwise, verify x402 payment
```

**Who Gets Bypass?**

| Auth Method | Bypass x402? | Why? |
|------------|-------------|------|
| **Privy JWT** (Next.js UI) | ✅ YES | Paying customers, bypass payment |
| **CDP Signature** (Dev UI) | ❌ NO | Internal dev tool, still pay when enabled |
| **No Auth** (AI Agents) | ❌ NO | External consumers must pay |

## Features

- **Gasless Transfers**: Uses EIP-3009 for fee-free USDC transfers on Base
- **Embedded Wallets**: Email-based wallet creation via Coinbase Developer Platform
- **HTTP 402 Flow**: Standard "Payment Required" protocol for API monetization
- **Base Network**: Supports both Base Sepolia (testnet) and Base (mainnet)
- **Persistent Conversations**: External agents can maintain multi-turn conversations via system user
- **Route-Based Pricing**: Simple flat pricing per request ($0.01 default)
- **Tool-Based Pricing**: Coming soon - dynamic pricing based on tools used

## Configuration

### 1. Authentication Setup (Optional - for whitelisted users)

> **Note**: Authentication is optional. Only configure if you need to bypass x402 payments for specific users.

```bash
# Privy Authentication (Optional - Next.js frontend - bypasses x402)
# Only needed if using Privy authentication for your frontend
PRIVY_APP_ID=your_privy_app_id
PRIVY_VERIFICATION_KEY="-----BEGIN PUBLIC KEY-----
MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE...
-----END PUBLIC KEY-----"

# CDP Wallet Signature TTL (for dev UI)
AUTH_SIGNATURE_TTL=300000  # 5 minutes
```

Get Privy credentials from [Privy Dashboard](https://dashboard.privy.io/) if you choose to use Privy authentication.

### 2. x402 Payment Setup

```bash
# Enable x402 payments
X402_ENABLED=true
X402_PAYMENT_ADDRESS=0xYourWalletAddress

# Environment configuration
X402_ENVIRONMENT=testnet  # or 'mainnet'
X402_NETWORK=base-sepolia  # or 'base' for mainnet
X402_USDC_ADDRESS=0x036CbD53842c5426634e7929541eC2318f3dCF7e
```

### 3. Coinbase CDP Credentials (for embedded wallets)

Get credentials from [Coinbase Developer Portal](https://portal.cdp.coinbase.com):

```bash
# API credentials for backend
CDP_API_KEY_ID=your_key_id
CDP_API_KEY_SECRET=your_key_secret

# Project ID for embedded wallets (frontend)
CDP_PROJECT_ID=your_project_id
```

See [.env.example](.env.example) for all configuration options.

## How It Works

### For End Users (Next.js UI with Privy)

1. **Sign Up**: User creates account with email via Privy authentication
2. **Pay Subscription**: User pays monthly/yearly subscription fee
3. **Free API Access**: All API requests are free (bypass x402)
4. **No Wallet Needed**: No crypto wallet or USDC required

### For External API Consumers (AI Agents)

1. **No Account Needed**: External agents don't need to create user accounts
2. **Make Request**: Send POST request to `/api/chat` with message
3. **Receive 402**: Server responds with payment requirement
4. **Sign Payment**: Sign USDC transfer authorization (gasless)
5. **Retry with Proof**: Resend request with payment header
6. **Get Response**: Receive AI response after payment verification
7. **Continue Conversation**: Use same `conversationId` for multi-turn conversations

### For Developers (Dev UI with CDP)

1. **Create Wallet**: Sign message with CDP wallet
2. **Deposit USDC**: Add USDC to wallet on Base network
3. **Make Requests**: Each request costs USDC when x402 is enabled
4. **Auto-Payment**: Payments are automatically deducted
5. **Track Usage**: View payment history in x402_payments table

## External API Consumers

External agents and AI systems can access the API through x402 micropayments without creating user accounts. The system automatically:

1. **Creates Persistent Conversations**: Uses a system user (`00000000-0000-0000-0000-000000000000`) to own external agent conversations
2. **Enables Multi-Turn Conversations**: External agents can continue conversations by providing the same `conversationId`
3. **Tracks Payments Separately**: Uses `x402_external` table instead of `x402_payments` for external consumer analytics

### System User

All external agent conversations are owned by a special system user in the database, enabling conversation persistence without requiring individual user accounts.

### Source Attribution

Requests are tagged with source identifiers for analytics:
- `external_ui` - Privy-authenticated Next.js frontend
- `dev_ui` - CDP-authenticated internal dev UI
- `x402_agent` - External API consumers (AI agents, scripts, etc.)

## Technical Payment Flow

### Standard x402 Flow (Dev UI & External Agents)

1. User/Agent makes a request to `/api/chat`
2. Server responds with **402 Payment Required** + payment details
3. Client shows payment confirmation modal (or auto-signs for agents)
4. Client signs payment authorization (gasless EIP-3009 transfer)
5. Client retries request with payment proof in `X-PAYMENT` header
6. Server verifies payment with facilitator
7. Server settles payment and processes the request
8. Server returns response with `X-PAYMENT-RESPONSE` header

### Privy Bypass Flow (Next.js Frontend)

1. User makes a request to `/api/chat` with Privy JWT
2. `smartAuthMiddleware` verifies JWT and sets `bypassX402 = true`
3. `x402Middleware` sees bypass flag and skips payment check
4. Server processes request immediately (no payment required)
5. Server returns response (no payment headers)

## Database Schema

The system uses two payment tracking tables based on user type:

### For Authenticated Users (Privy/CDP) - `x402_payments`

```sql
CREATE TABLE x402_payments (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  conversation_id UUID REFERENCES conversations(id),
  message_id UUID REFERENCES messages(id),
  amount_usd NUMERIC NOT NULL,
  amount_wei TEXT NOT NULL,
  asset TEXT DEFAULT 'USDC',
  network TEXT NOT NULL,
  tools_used TEXT[],
  tx_hash TEXT,
  network_id TEXT,
  payment_status TEXT CHECK (payment_status IN ('pending', 'verified', 'settled', 'failed')),
  payment_header JSONB,
  payment_requirements JSONB,
  error_message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  verified_at TIMESTAMPTZ,
  settled_at TIMESTAMPTZ
);
```

### For External API Consumers - `x402_external`

```sql
CREATE TABLE x402_external (
  id UUID PRIMARY KEY,
  conversation_id UUID NOT NULL REFERENCES conversations(id), -- Links to system user conversation
  request_path TEXT NOT NULL,
  tx_hash TEXT,
  amount_usd NUMERIC,
  amount_wei TEXT,
  asset TEXT DEFAULT 'USDC',
  network TEXT,
  network_id TEXT,
  payment_status TEXT CHECK (payment_status IN ('pending', 'verified', 'settled', 'failed')),
  payment_header JSONB,
  payment_requirements JSONB,
  request_metadata JSONB, -- Stores providedUserId, fileInfo, etc.
  response_time INTEGER,
  error_message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Payment Stats View

```sql
CREATE VIEW user_payment_stats AS
SELECT
  user_id,
  COUNT(*) AS total_payments,
  SUM(amount_usd) AS total_spent_usd,
  AVG(amount_usd) AS avg_payment_usd,
  COUNT(*) FILTER (WHERE payment_status = 'verified') AS verified_payments,
  COUNT(*) FILTER (WHERE payment_status = 'settled') AS settled_payments,
  COUNT(*) FILTER (WHERE payment_status = 'failed') AS failed_payments,
  MAX(created_at) AS last_payment_at,
  MIN(created_at) AS first_payment_at
FROM x402_payments
WHERE user_id IS NOT NULL
GROUP BY user_id;
```

Full schema available in [src/db/setup.sql](src/db/setup.sql).

## Pricing Configuration

### Route-Based Pricing (Current)

Simple flat pricing per request configured in [src/x402/pricing.ts](src/x402/pricing.ts):

```typescript
export const routePricing: RoutePricing[] = [
  {
    route: "/api/chat",
    priceUSD: "0.01", // $0.01 per chat request
    description: "Chat API access (includes all tools)",
  },
];
```

### Tool-Based Pricing (Coming Soon)

Dynamic pricing based on actual tools used:

```typescript
export const toolPricing: Record<string, ToolPricing> = {
  // Free tier
  PLANNING: { priceUSD: "0.00", tier: "free" },
  REPLY: { priceUSD: "0.00", tier: "free" },
  KNOWLEDGE: { priceUSD: "0.00", tier: "free" },

  // Premium tier
  OPENSCHOLAR: { priceUSD: "0.10", tier: "premium" },
  "SEMANTIC-SCHOLAR": { priceUSD: "0.10", tier: "premium" },
  HYPOTHESIS: { priceUSD: "0.05", tier: "basic" },
};
```

## Production Readiness TODOs

### Phase 1 - Critical (Implement Now)

- [ ] Initialize payment_status as "pending" in x402_external record creation
- [ ] Add payment amount validation in middleware (verify payment matches expected cost)
- [ ] Add tx_hash duplicate detection to prevent replay attacks
- [ ] Implement proper error handling for payment failures

### Phase 2 - Important (Next Week)

- [ ] Implement rate limiting per conversationId for external agents
- [ ] Add payment metrics and monitoring dashboard
- [ ] Create conversation history API endpoint (`GET /api/conversation/:id/history`)
- [ ] Write integration tests for x402_external flow

### Phase 3 - Nice to Have (Next Month)

- [ ] Implement data retention/archiving for old payments
- [ ] Add webhook notifications for payment status changes
- [ ] Create client SDK examples (TypeScript/Python)
- [ ] Add OpenAPI documentation for external consumers

See TODO comments in code for implementation details:
- [src/routes/chat.ts](src/routes/chat.ts) - Rate limiting TODO
- [src/middleware/x402.ts](src/middleware/x402.ts) - Payment validation TODO

## Implementation Details

### Backend Architecture

```
src/
├── routes/
│   └── chat.ts              # Main chat endpoint (orchestrates services)
├── services/
│   └── chat/                # Chat-related services
│       ├── setup.ts         # User/conversation setup
│       ├── payment.ts       # Payment recording
│       └── tools.ts         # Tool execution logic
├── middleware/
│   ├── smartAuth.ts         # Multi-method authentication
│   └── x402.ts              # Payment enforcement
├── db/
│   ├── operations.ts        # Core DB operations
│   └── x402Operations.ts    # Payment tracking operations
└── x402/
    ├── config.ts            # Network & payment config
    ├── pricing.ts           # Route-based pricing
    └── service.ts           # Payment verification & settlement
```

### Key Files

- **Routes**: [src/routes/chat.ts](src/routes/chat.ts)
- **Services**: [src/services/chat/](src/services/chat/)
- **Middleware**: [src/middleware/smartAuth.ts](src/middleware/smartAuth.ts), [src/middleware/x402.ts](src/middleware/x402.ts)
- **Payment Logic**: [src/x402/](src/x402/)
- **Database**: [src/db/x402Operations.ts](src/db/x402Operations.ts)
- **Frontend Hooks**: `client/src/hooks/useX402Payment.ts`, `client/src/hooks/useEmbeddedWallet.ts`

## Testing

### Test External Agent Flow (with x402-fetch)

```bash
# Install x402-fetch
npm install x402-fetch

# Make a paid request
node test-x402-agent.js
```

```javascript
// test-x402-agent.js
import { x402Fetch } from 'x402-fetch';

const response = await x402Fetch('http://localhost:3000/api/chat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    message: 'What is DNA?',
    conversationId: 'test-conv-123' // Optional: for multi-turn
  }),
  // x402 wallet configuration
  x402: {
    privateKey: process.env.WALLET_PRIVATE_KEY,
    network: 'base-sepolia'
  }
});

const data = await response.json();
console.log(data.text);
```

### Test Privy Bypass Flow

```bash
curl -X POST http://localhost:3000/api/chat \
  -H "Authorization: Bearer YOUR_PRIVY_JWT" \
  -H "Content-Type: application/json" \
  -d '{"message": "What is DNA?"}'
```

### Test CDP Flow (Dev UI)

See [client/](client/) for full dev UI implementation.

## Troubleshooting

### Payment Verification Failed

**Issue**: `x402_payment_invalid` error

**Solutions**:
- Check if payment amount matches expected cost
- Verify USDC balance in wallet
- Check network configuration (testnet vs mainnet)
- Ensure facilitator URL is correct

### Bypass Not Working

**Issue**: Privy users still getting 402 Payment Required

**Solutions**:
- Verify PRIVY_VERIFICATION_KEY is configured correctly
- Check JWT format (should start with "Bearer ")
- Verify Privy App ID matches dashboard
- Check middleware order (smartAuth must run before x402)

### External Agent Conversations Not Persisting

**Issue**: Multi-turn conversations not working

**Solutions**:
- Verify system user exists in database (`00000000-0000-0000-0000-000000000000`)
- Use same `conversationId` for follow-up messages
- Check x402_external table for conversation records

## Resources

- [x402 Protocol Specification](https://x402.org)
- [Coinbase Developer Platform](https://portal.cdp.coinbase.com)
- [Privy Documentation](https://docs.privy.io)
- [Base Network](https://base.org)
- [EIP-3009: Transfer With Authorization](https://eips.ethereum.org/EIPS/eip-3009)

## Support

For issues or questions:
- GitHub Issues: [bioagents-agentkit/issues](https://github.com/bio-xyz/bioagents-agentkit/issues)
- Documentation: See [README.md](README.md) for general setup
- Configuration: See [.env.example](.env.example) for all options
